<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scientific Calculator</title>
    <script src="../Hidden/Script/math.min.js"></script>
    <script src="../Hidden/Script/cdn.tailwindcss.com.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        calculator: {
                            body: '#1e272e',
                            display: '#c8d6e5',
                            displayDark: '#222f3e',
                            key: '#f1f2f6',
                            keyDark: '#576574',
                            keyFunction: '#ff6b6b',
                            keyBorder: '#8395a7',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .calculator-key {
            transition: all 0.1s;
            user-select: none;
        }
        .calculator-key:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .dark .display-screen {
            background-color: #263238;
            color: #ecf0f1;
        }
        /* Customize scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3436;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dot {
            transition: transform 0.2s;
        }
        input:checked + .block {
            background-color: #4CAF50;
        }
        input:checked + .block + .dot {
            transform: translateX(100%);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col items-center justify-center p-4">
    <div class="calculator-body bg-calculator-body rounded-2xl shadow-2xl p-3 max-w-md w-full mx-auto">
        <div class="calculator-header mb-4">
            <div class="flex justify-between items-center">
                <div class="text-white font-bold">CASIO fx-50FHII</div>
                <div class="flex space-x-2">
                    <div class="bg-calculator-keyFunction h-4 w-10 rounded"></div>
                    <div class="h-4 w-4 rounded-full bg-gray-400 flex items-center justify-center">
                        <div class="text-xs text-white">S</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="calculator-display bg-calculator-display rounded-lg p-2 mb-4">
            <div id="formula-display" class="h-6 text-right text-sm overflow-x-auto whitespace-nowrap mb-1 display-screen"></div>
            <div id="result-display" class="h-8 text-right text-xl font-bold overflow-x-auto whitespace-nowrap display-screen">0</div>
        </div>
        
        <div class="calculator-mode-selector mb-4">
            <div class="grid grid-cols-5 gap-1 text-xs text-white">
                <button class="bg-calculator-keyDark p-1 rounded mode-btn" data-mode="COMP">COMP</button>
                <button class="bg-calculator-keyDark p-1 rounded mode-btn" data-mode="CMPLX">CMPLX</button>
                <button class="bg-calculator-keyDark p-1 rounded mode-btn" data-mode="STAT">STAT</button>
                <button class="bg-calculator-keyDark p-1 rounded mode-btn" data-mode="BASE">BASE</button>
                <button class="bg-calculator-keyDark p-1 rounded mode-btn" data-mode="PROG">PROG</button>
            </div>
        </div>
        
        <!-- Function keys -->
        <div class="calculator-function-keys grid grid-cols-5 gap-1 mb-2">
            <button class="calculator-key bg-calculator-keyFunction text-white rounded p-1 text-xs function-key" data-fn="shift">SHIFT</button>
            <button class="calculator-key bg-calculator-keyFunction text-white rounded p-1 text-xs function-key" data-fn="alpha">ALPHA</button>
            <button class="calculator-key bg-calculator-keyDark text-white rounded p-1 text-xs function-key" data-fn="const">CONST</button>
            <button class="calculator-key bg-calculator-keyDark text-white rounded p-1 text-xs function-key" data-fn="formula">FORMULA</button>
            <button class="calculator-key bg-calculator-keyDark text-white rounded p-1 text-xs function-key" data-fn="replay">REPLAY</button>
        </div>
        
        <!-- Main keypad - standard keys -->
        <div id="standard-keypad" class="calculator-keypad grid grid-cols-5 gap-1">
            <!-- Row 1 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="nCr">nCr</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="nPr">nPr</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="Pol">Pol</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="Rec">Rec</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="i">i</button>
            
            <!-- Row 2 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="√">√</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="x²">x²</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="^">^</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="log">log</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="ln">ln</button>
            
            <!-- Row 3 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="(">(</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key=")">)</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="S-D">S⇔D</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="M+">M+</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="M-">M-</button>
            
            <!-- Row 4 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="7">7</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="8">8</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="9">9</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="DEL">DEL</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="AC">AC</button>
            
            <!-- Row 5 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="4">4</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="5">5</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="6">6</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="×">×</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="÷">÷</button>
            
            <!-- Row 6 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="1">1</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="2">2</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="3">3</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="+">+</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="-">−</button>
            
            <!-- Row 7 -->
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="0">0</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key=".">.</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="EXP">EXP</button>
            <button class="calculator-key bg-calculator-key dark:bg-calculator-keyDark dark:text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="Ans">Ans</button>
            <button class="calculator-key bg-calculator-keyFunction text-white border border-calculator-keyBorder rounded p-2 text-sm" data-key="=">=</button>
        </div>
        
        <!-- Hidden keypads for other modes -->
        <div id="cmplx-keypad" class="calculator-keypad grid grid-cols-5 gap-1 hidden">
            <!-- Complex number specific keys -->
            <!-- This will be populated when switching to CMPLX mode -->
        </div>
        
        <div id="stat-keypad" class="calculator-keypad grid grid-cols-5 gap-1 hidden">
            <!-- Statistics specific keys -->
            <!-- This will be populated when switching to STAT mode -->
        </div>
        
        <div id="base-keypad" class="calculator-keypad grid grid-cols-5 gap-1 hidden">
            <!-- Base-n specific keys -->
            <!-- This will be populated when switching to BASE mode -->
        </div>
        
        <div id="prog-keypad" class="calculator-keypad grid grid-cols-5 gap-1 hidden">
            <!-- Programming specific keys -->
            <!-- This will be populated when switching to PROG mode -->
        </div>
        
        <!-- Constants Modal -->
        <div id="constants-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-10">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold dark:text-white">Scientific Constants</h3>
                    <button id="close-constants" class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">×</button>
                </div>
                <div class="grid grid-cols-1 gap-2" id="constants-list"></div>
            </div>
        </div>
        
        <!-- Formulas Modal -->
        <div id="formulas-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-10">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold dark:text-white">Built-in Formulas</h3>
                    <button id="close-formulas" class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">×</button>
                </div>
                <div class="grid grid-cols-1 gap-2" id="formulas-list"></div>
            </div>
        </div>
        
        <!-- Statistics Data Editor Modal -->
        <div id="stat-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-10">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold dark:text-white">Statistical Data Editor</h3>
                    <button id="close-stat-editor" class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">×</button>
                </div>
                <div class="mb-4">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-100 dark:bg-gray-700">
                                <th class="border p-1 dark:text-white">No.</th>
                                <th class="border p-1 dark:text-white">X</th>
                                <th class="border p-1 dark:text-white">Y</th>
                            </tr>
                        </thead>
                        <tbody id="stat-data-table">
                            <!-- Data rows will be added here -->
                        </tbody>
                    </table>
                </div>
                <div class="flex space-x-2">
                    <button id="add-stat-row" class="bg-blue-500 text-white px-3 py-1 rounded">Add Row</button>
                    <button id="calc-stat" class="bg-green-500 text-white px-3 py-1 rounded">Calculate</button>
                </div>
            </div>
        </div>
        
        <!-- Program Editor Modal -->
        <div id="program-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-10">
            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold dark:text-white">Program Editor</h3>
                    <button id="close-program-editor" class="text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">×</button>
                </div>
                <div class="mb-4">
                    <div class="flex space-x-2 mb-2">
                        <button class="program-area-btn bg-gray-200 dark:bg-gray-700 dark:text-white px-2 py-1 rounded" data-area="1">Prog 1</button>
                        <button class="program-area-btn bg-gray-200 dark:bg-gray-700 dark:text-white px-2 py-1 rounded" data-area="2">Prog 2</button>
                        <button class="program-area-btn bg-gray-200 dark:bg-gray-700 dark:text-white px-2 py-1 rounded" data-area="3">Prog 3</button>
                        <button class="program-area-btn bg-gray-200 dark:bg-gray-700 dark:text-white px-2 py-1 rounded" data-area="4">Prog 4</button>
                    </div>
                    <textarea id="program-code" class="w-full h-48 p-2 border rounded dark:bg-gray-700 dark:text-white dark:border-gray-600" placeholder="Enter program code here..."></textarea>
                </div>
                <div class="flex space-x-2">
                    <button id="save-program" class="bg-blue-500 text-white px-3 py-1 rounded">Save</button>
                    <button id="run-program" class="bg-green-500 text-white px-3 py-1 rounded">Run</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check for dark mode
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Calculator state
        const calculatorState = {
            currentInput: '',
            formulaDisplay: '',
            result: '0',
            lastResult: '0',
            memory: 0,
            variables: { A: 0, B: 0, C: 0, D: 0, E: 0, F: 0, X: 0 },
            mode: 'COMP', // COMP, CMPLX, STAT, BASE, PROG
            shift: false,
            alpha: false,
            base: 10, // For base-n calculations: 2, 8, 10, 16
            statData: [], // For statistics
            programs: ['', '', '', ''], // 4 program areas
            replayHistory: [], // For multi-replay function
            currentReplayIndex: -1
        };

        // Constants data
        const scientificConstants = {
            'c': { value: 299792458, description: 'Speed of light in vacuum' },
            'g': { value: 9.80665, description: 'Standard acceleration of gravity' },
            'h': { value: 6.62607015e-34, description: 'Planck constant' },
            'e': { value: 1.602176634e-19, description: 'Elementary charge' },
            'me': { value: 9.1093837015e-31, description: 'Electron mass' },
            'mp': { value: 1.67262192369e-27, description: 'Proton mass' },
            'mn': { value: 1.67492749804e-27, description: 'Neutron mass' },
            'NA': { value: 6.02214076e23, description: 'Avogadro constant' },
            'k': { value: 1.380649e-23, description: 'Boltzmann constant' },
            'ε0': { value: 8.8541878128e-12, description: 'Vacuum electric permittivity' },
            'μ0': { value: 1.25663706212e-6, description: 'Vacuum magnetic permeability' },
            'R': { value: 8.31446261815324, description: 'Gas constant' },
            'π': { value: Math.PI, description: 'Pi constant' },
            'e (Euler)': { value: Math.E, description: 'Euler\'s number' },
            'G': { value: 6.67430e-11, description: 'Gravitational constant' }
            // Would add more constants to reach 40 as specified
        };

        // Built-in formulas
        const builtInFormulas = {
            'Quadratic Formula': { formula: 'x = (-b ± √(b² - 4ac)) / 2a', description: 'Solves ax² + bx + c = 0' },
            'Pythagorean Theorem': { formula: 'c = √(a² + b²)', description: 'Right triangle hypotenuse' },
            'Area of Circle': { formula: 'A = πr²', description: 'Area using radius' },
            'Circumference': { formula: 'C = 2πr', description: 'Circumference of circle' },
            'Volume of Sphere': { formula: 'V = (4/3)πr³', description: 'Volume using radius' },
            'Kinetic Energy': { formula: 'E = (1/2)mv²', description: 'Energy of moving object' },
            'Einstein\'s Mass-Energy': { formula: 'E = mc²', description: 'Mass-energy equivalence' },
            'Simple Interest': { formula: 'I = Prt', description: 'P=principal, r=rate, t=time' },
            'Compound Interest': { formula: 'A = P(1 + r/n)^(nt)', description: 'Amount after compound interest' },
            'Distance Formula': { formula: 'd = √[(x₂-x₁)² + (y₂-y₁)²]', description: 'Distance between two points' }
            // Would add more formulas to reach 23 as specified
        };

        // DOM Elements
        const formulaDisplay = document.getElementById('formula-display');
        const resultDisplay = document.getElementById('result-display');
        const constantsModal = document.getElementById('constants-modal');
        const formulasModal = document.getElementById('formulas-modal');
        const statEditorModal = document.getElementById('stat-editor-modal');
        const programEditorModal = document.getElementById('program-editor-modal');

        // Initialize Constants Modal
        function initConstantsModal() {
            const constantsList = document.getElementById('constants-list');
            constantsList.innerHTML = '';
            
            Object.entries(scientificConstants).forEach(([name, data]) => {
                const constantItem = document.createElement('div');
                constantItem.className = 'p-2 border rounded dark:border-gray-700';
                constantItem.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-medium dark:text-white">${name}</span>
                        <span class="text-gray-700 dark:text-gray-300">${data.value}</span>
                    </div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${data.description}</div>
                `;
                constantItem.addEventListener('click', () => {
                    insertConstant(name, data.value);
                    constantsModal.classList.add('hidden');
                });
                constantsList.appendChild(constantItem);
            });

            document.getElementById('close-constants').addEventListener('click', () => {
                constantsModal.classList.add('hidden');
            });
        }

        // Initialize Formulas Modal
        function initFormulasModal() {
            const formulasList = document.getElementById('formulas-list');
            formulasList.innerHTML = '';
            
            Object.entries(builtInFormulas).forEach(([name, data]) => {
                const formulaItem = document.createElement('div');
                formulaItem.className = 'p-2 border rounded dark:border-gray-700';
                formulaItem.innerHTML = `
                    <div class="font-medium dark:text-white">${name}</div>
                    <div class="text-gray-700 dark:text-gray-300">${data.formula}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">${data.description}</div>
                `;
                formulaItem.addEventListener('click', () => {
                    // Logic to use the formula
                    useFormula(name, data.formula);
                    formulasModal.classList.add('hidden');
                });
                formulasList.appendChild(formulaItem);
            });

            document.getElementById('close-formulas').addEventListener('click', () => {
                formulasModal.classList.add('hidden');
            });
        }

        // Initialize Statistics Editor
        function initStatEditor() {
            const statDataTable = document.getElementById('stat-data-table');
            
            function refreshStatTable() {
                statDataTable.innerHTML = '';
                calculatorState.statData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border p-1 dark:text-white">${index + 1}</td>
                        <td class="border p-1">
                            <input type="number" value="${item.x}" class="w-full px-1 py-0.5 dark:bg-gray-700 dark:text-white dark:border-gray-600" data-index="${index}" data-type="x">
                        </td>
                        <td class="border p-1">
                            <input type="number" value="${item.y}" class="w-full px-1 py-0.5 dark:bg-gray-700 dark:text-white dark:border-gray-600" data-index="${index}" data-type="y">
                        </td>
                    `;
                    statDataTable.appendChild(row);
                });
                
                // Add event listeners to inputs
                statDataTable.querySelectorAll('input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const type = e.target.dataset.type;
                        calculatorState.statData[index][type] = parseFloat(e.target.value) || 0;
                    });
                });
            }
            
            // Add initial row if empty
            if (calculatorState.statData.length === 0) {
                calculatorState.statData.push({ x: 0, y: 0 });
            }
            
            refreshStatTable();
            
            // Add row button
            document.getElementById('add-stat-row').addEventListener('click', () => {
                calculatorState.statData.push({ x: 0, y: 0 });
                refreshStatTable();
            });
            
            // Calculate button
            document.getElementById('calc-stat').addEventListener('click', () => {
                calculateStatistics();
                statEditorModal.classList.add('hidden');
            });
            
            document.getElementById('close-stat-editor').addEventListener('click', () => {
                statEditorModal.classList.add('hidden');
            });
        }

        // Initialize Program Editor
        function initProgramEditor() {
            const programCode = document.getElementById('program-code');
            let currentProgramArea = 0;
            
            // Program area buttons
            document.querySelectorAll('.program-area-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const area = parseInt(e.target.dataset.area) - 1;
                    currentProgramArea = area;
                    programCode.value = calculatorState.programs[area];
                    
                    // Update active button
                    document.querySelectorAll('.program-area-btn').forEach(b => {
                        b.classList.remove('bg-blue-500', 'text-white');
                        b.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    });
                    e.target.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    e.target.classList.add('bg-blue-500', 'text-white');
                });
            });
            
            // Save button
            document.getElementById('save-program').addEventListener('click', () => {
                calculatorState.programs[currentProgramArea] = programCode.value;
                alert(`Program ${currentProgramArea + 1} saved`);
            });
            
            // Run button
            document.getElementById('run-program').addEventListener('click', () => {
                executeProgram(currentProgramArea);
                programEditorModal.classList.add('hidden');
            });
            
            document.getElementById('close-program-editor').addEventListener('click', () => {
                programEditorModal.classList.add('hidden');
            });
            
            // Select first program area by default
            document.querySelector('.program-area-btn[data-area="1"]').click();
        }

        // Add event listeners to calculator keys
        function initCalculatorKeys() {
            // Standard keys
            document.querySelectorAll('.calculator-key').forEach(key => {
                key.addEventListener('click', () => {
                    const keyValue = key.getAttribute('data-key');
                    handleKeyPress(keyValue);
                });
            });
            
            // Function keys
            document.querySelectorAll('.function-key').forEach(key => {
                key.addEventListener('click', () => {
                    const fnType = key.getAttribute('data-fn');
                    handleFunctionKey(fnType);
                });
            });
            
            // Mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.getAttribute('data-mode');
                    switchMode(mode);
                });
            });
        }

        function handleKeyPress(key) {
            switch (key) {
                case 'AC':
                    clearAll();
                    break;
                case 'DEL':
                    deleteLastChar();
                    break;
                case '=':
                    calculateResult();
                    break;
                case 'Ans':
                    appendToInput('Ans');
                    break;
                case 'M+':
                    memoryAdd();
                    break;
                case 'M-':
                    memorySubtract();
                    break;
                case 'S-D':
                    convertFractionDecimal();
                    break;
                case 'nCr':
                    appendToInput('nCr(');
                    break;
                case 'nPr':
                    appendToInput('nPr(');
                    break;
                case 'Pol':
                    appendToInput('Pol(');
                    break;
                case 'Rec':
                    appendToInput('Rec(');
                    break;
                case 'i':
                    appendToInput('i');
                    break;
                case '√':
                    appendToInput('sqrt(');
                    break;
                case 'x²':
                    appendToInput('^2');
                    break;
                case '^':
                    appendToInput('^');
                    break;
                case 'log':
                    appendToInput('log(');
                    break;
                case 'ln':
                    appendToInput('ln(');
                    break;
                case 'EXP':
                    appendToInput('e');
                    break;
                default:
                    // Handle operators and numbers
                    if (key === '×') {
                        appendToInput('*');
                    } else if (key === '÷') {
                        appendToInput('/');
                    } else {
                        appendToInput(key);
                    }
            }
            
            updateDisplay();
        }

        function handleFunctionKey(fnType) {
            switch (fnType) {
                case 'shift':
                    calculatorState.shift = !calculatorState.shift;
                    calculatorState.alpha = false;
                    break;
                case 'alpha':
                    calculatorState.alpha = !calculatorState.alpha;
                    calculatorState.shift = false;
                    break;
                case 'const':
                    showConstantsModal();
                    break;
                case 'formula':
                    showFormulasModal();
                    break;
                case 'replay':
                    useReplayFunction();
                    break;
            }
        }

        function switchMode(mode) {
            calculatorState.mode = mode;
            
            // Hide all keypads
            document.querySelectorAll('.calculator-keypad').forEach(keypad => {
                keypad.classList.add('hidden');
            });
            
            // Show keypad based on mode
            switch (mode) {
                case 'COMP':
                    document.getElementById('standard-keypad').classList.remove('hidden');
                    break;
                case 'CMPLX':
                    document.getElementById('cmplx-keypad').classList.remove('hidden');
                    // If cmplx-keypad is empty, we'll show the standard keypad
                    if (document.getElementById('cmplx-keypad').children.length === 0) {
                        document.getElementById('standard-keypad').classList.remove('hidden');
                    }
                    break;
                case 'STAT':
                    showStatEditor();
                    document.getElementById('standard-keypad').classList.remove('hidden');
                    break;
                case 'BASE':
                    document.getElementById('base-keypad').classList.remove('hidden');
                    // If base-keypad is empty, we'll show the standard keypad
                    if (document.getElementById('base-keypad').children.length === 0) {
                        document.getElementById('standard-keypad').classList.remove('hidden');
                    }
                    break;
                case 'PROG':
                    showProgramEditor();
                    document.getElementById('standard-keypad').classList.remove('hidden');
                    break;
            }
            
            // Update display to show current mode
            resultDisplay.textContent = `Mode: ${mode}`;
            formulaDisplay.textContent = '';
            calculatorState.currentInput = '';
        }

        // Helper Functions
        function appendToInput(value) {
            calculatorState.currentInput += value;
        }

        function clearAll() {
            calculatorState.currentInput = '';
            calculatorState.formulaDisplay = '';
            calculatorState.result = '0';
            updateDisplay();
        }

        function deleteLastChar() {
            calculatorState.currentInput = calculatorState.currentInput.slice(0, -1);
            updateDisplay();
        }

        function calculateResult() {
            if (!calculatorState.currentInput) return;

            try {
                // Add the current calculation to replay history
                calculatorState.replayHistory.push(calculatorState.currentInput);
                if (calculatorState.replayHistory.length > 10) {
                    calculatorState.replayHistory.shift(); // Keep only last 10 entries
                }
                calculatorState.currentReplayIndex = calculatorState.replayHistory.length;

                // Save formula to display
                calculatorState.formulaDisplay = calculatorState.currentInput;

                // Replace some syntax for math.js
                let expression = calculatorState.currentInput
                    .replace(/Ans/g, calculatorState.lastResult)
                    .replace(/log\(/g, 'log10(')
                    .replace(/ln\(/g, 'log(')
                    .replace(/sqrt\(/g, 'sqrt(')
                    .replace(/nCr\((\d+),(\d+)\)/g, (_, n, r) => {
                        return `combinations(${n}, ${r})`;
                    })
                    .replace(/nPr\((\d+),(\d+)\)/g, (_, n, r) => {
                        return `permutations(${n}, ${r})`;
                    });

                // Handle base-n calculations in BASE mode
                if (calculatorState.mode === 'BASE') {
                    // Special handling for base-n calculations
                    // This would need to be implemented based on how the calculator handles base-n
                }

                // Handle complex numbers in CMPLX mode
                if (calculatorState.mode === 'CMPLX') {
                    // Special handling for complex numbers
                    // This would involve parsing and operations with the 'i' symbol
                }

                // Calculate the result
                let result;
                if (calculatorState.mode === 'BASE' && calculatorState.base !== 10) {
                    // Calculate in base 10 and convert back to the current base
                    result = math.evaluate(expression);
                    result = convertToBase(result, calculatorState.base);
                } else {
                    result = math.evaluate(expression);
                }

                // Format the result
                calculatorState.result = typeof result === 'number' ? 
                    result.toString() : 
                    result.toString();
                
                calculatorState.lastResult = calculatorState.result;
                calculatorState.currentInput = '';
            } catch (error) {
                calculatorState.result = 'Error';
                calculatorState.currentInput = '';
            }

            updateDisplay();
        }

        function updateDisplay() {
            formulaDisplay.textContent = calculatorState.currentInput || calculatorState.formulaDisplay || '';
            resultDisplay.textContent = calculatorState.result;
            
            // Auto-scroll display to the right
            formulaDisplay.scrollLeft = formulaDisplay.scrollWidth;
            resultDisplay.scrollLeft = resultDisplay.scrollWidth;
        }

        function memoryAdd() {
            if (calculatorState.result === 'Error') return;
            
            try {
                const value = parseFloat(calculatorState.result);
                if (!isNaN(value)) {
                    calculatorState.memory += value;
                    resultDisplay.textContent = 'M+';
                    setTimeout(() => {
                        updateDisplay();
                    }, 500);
                }
            } catch (error) {
                // Handle error
            }
        }

        function memorySubtract() {
            if (calculatorState.result === 'Error') return;
            
            try {
                const value = parseFloat(calculatorState.result);
                if (!isNaN(value)) {
                    calculatorState.memory -= value;
                    resultDisplay.textContent = 'M-';
                    setTimeout(() => {
                        updateDisplay();
                    }, 500);
                }
            } catch (error) {
                // Handle error
            }
        }

        function convertFractionDecimal() {
            // Toggle between fraction and decimal representation
            if (calculatorState.result === 'Error') return;
            
            try {
                const value = math.evaluate(calculatorState.result);
                
                if (typeof value === 'number') {
                    // Check if the current display looks like a decimal
                    if (calculatorState.result.includes('.')) {
                        // Convert to fraction
                        const fraction = math.format(value, {fraction: 'ratio'});
                        calculatorState.result = fraction;
                    } else {
                        // Convert to decimal
                        calculatorState.result = value.toString();
                    }
                    updateDisplay();
                }
            } catch (error) {
                // Handle error
            }
        }

        function showConstantsModal() {
            constantsModal.classList.remove('hidden');
        }

        function showFormulasModal() {
            formulasModal.classList.remove('hidden');
        }

        function showStatEditor() {
            initStatEditor();
            statEditorModal.classList.remove('hidden');
        }

        function showProgramEditor() {
            initProgramEditor();
            programEditorModal.classList.remove('hidden');
        }

        function insertConstant(name, value) {
            calculatorState.currentInput += value.toString();
            updateDisplay();
        }

        function useFormula(name, formula) {
            // This is a simplified implementation
            // In a real calculator, formulas would typically open a form to input variables
            calculatorState.formulaDisplay = name;
            calculatorState.currentInput = '';
            calculatorState.result = formula;
            updateDisplay();
        }

        function calculateStatistics() {
            if (calculatorState.statData.length === 0) {
                calculatorState.result = 'No data';
                updateDisplay();
                return;
            }
            
            try {
                // Calculate basic statistics
                const xValues = calculatorState.statData.map(d => d.x);
                const yValues = calculatorState.statData.map(d => d.y);
                
                const meanX = xValues.reduce((a, b) => a + b, 0) / xValues.length;
                const meanY = yValues.reduce((a, b) => a + b, 0) / yValues.length;
                
                // Standard deviation calculation
                const sumSqDiffX = xValues.reduce((a, b) => a + Math.pow(b - meanX, 2), 0);
                const sumSqDiffY = yValues.reduce((a, b) => a + Math.pow(b - meanY, 2), 0);
                
                const stdDevX = Math.sqrt(sumSqDiffX / xValues.length);
                const stdDevY = Math.sqrt(sumSqDiffY / yValues.length);
                
                // Display results
                calculatorState.result = `x̄=${meanX.toFixed(4)}, σx=${stdDevX.toFixed(4)}`;
                calculatorState.formulaDisplay = 'Statistics';
                
                updateDisplay();
            } catch (error) {
                calculatorState.result = 'Error';
                updateDisplay();
            }
        }

        function executeProgram(programArea) {
            const program = calculatorState.programs[programArea];
            if (!program) {
                calculatorState.result = 'No program';
                updateDisplay();
                return;
            }
            
            try {
                // Very basic BASIC-like interpreter
                // This is a simplified implementation
                const lines = program.split('\n');
                let result = '';
                
                for (const line of lines) {
                    if (line.trim().startsWith('PRINT ')) {
                        const expression = line.trim().substring(6);
                        const value = math.evaluate(expression);
                        result += value + '\n';
                    }
                    // Add more commands as needed
                }
                
                calculatorState.result = result.trim() || 'Done';
                calculatorState.formulaDisplay = `Program ${programArea + 1}`;
                updateDisplay();
            } catch (error) {
                calculatorState.result = 'Error';
                updateDisplay();
            }
        }

        function useReplayFunction() {
            if (calculatorState.replayHistory.length === 0) {
                return;
            }
            
            // Navigate through history
            if (calculatorState.currentReplayIndex <= 0) {
                calculatorState.currentReplayIndex = calculatorState.replayHistory.length;
            }
            
            calculatorState.currentReplayIndex--;
            calculatorState.currentInput = calculatorState.replayHistory[calculatorState.currentReplayIndex];
            updateDisplay();
        }

        function convertToBase(number, base) {
            // Convert a decimal number to the specified base (2, 8, 16)
            if (base === 10) return number.toString();
            
            let result;
            
            if (base === 2) {
                result = Math.floor(number).toString(2);
            } else if (base === 8) {
                result = Math.floor(number).toString(8);
            } else if (base === 16) {
                result = Math.floor(number).toString(16).toUpperCase();
            }
            
            return result;
        }

        // Initialize the calculator
        function initCalculator() {
            initCalculatorKeys();
            initConstantsModal();
            initFormulasModal();
            updateDisplay();
        }

        // Start the calculator
        initCalculator();
    </script>


</body>
<!-- Add this at the bottom of the body, before the closing </body> tag -->
<div class="flex justify-center mt-6">
    <label for="theme-toggle" class="flex items-center cursor-pointer">
        <div class="relative">
            <input type="checkbox" id="theme-toggle" class="hidden" />
            <div class="block bg-gray-600 w-14 h-8 rounded-full"></div>
            <div class="dot absolute left-1 top-1 bg-white w-6 h-6 rounded-full transition"></div>
        </div>
        <div class="ml-3 text-gray-700 dark:text-gray-300">Toggle Dark/Light Theme</div>
    </label>
</div>

<script>
    const toggle = document.getElementById('theme-toggle');

    // Load the saved theme from localStorage or default to light mode
    if (localStorage.getItem('theme') === 'dark') {
        document.documentElement.classList.add('dark');
        toggle.checked = true;
    }

    // Toggle theme on change
    toggle.addEventListener('change', () => {
        if (toggle.checked) {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
        } else {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
        }
    });
</script></html>
